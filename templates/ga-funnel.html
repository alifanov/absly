{% extends 'base.html' %}

{% block content %}
    <div class="container metrics ga-config">
        <h1>Воронка Google Analytics</h1>
        <table class="table">
            <thead>
                <th>Level</th>
                <th>Value</th>
                <th>Funnel</th>
            </thead>
            <tr>
                <td>Acquisition</td>
                <td>{{ ga_users|default:"0" }}</td>
                <td>
                    <div id="ga_acquisition" style="min-height: 50px;"></div>
                </td>
            </tr>
            <tr>
                <td>Activation</td>
                <td>
                    {% if activation_value %}
                        {{ activation_value|default:"0" }}
                    {% else %}
                        <input name="activation_value" />
                    {% endif %}
                </td>
                <td>
                    <div id="ga_activation"></div>
                </td>
            </tr>
            <tr>
                <td>Retention</td>
                <td>
                    {% if retention_value %}
                        {{ retention_value|default:"0" }}
                    {% else %}
                        <input name="retention_value" />
                    {% endif %}
                </td>
                <td>
                    <div id="ga_retention"></div>
                </td>
            </tr>
            <tr>
                <td>Referral</td>
                <td>
                    {% if referral_value %}
                        {{ referral_value|default:"0" }}
                    {% else %}
                        <input name="referral_value" />
                    {% endif %}
                </td>
                <td>
                    <div id="ga_referral"></div>
                </td>
            </tr>
            <tr>
                <td>Revenue</td>
                <td>
                    {% if revenue_value %}
                        {{ revenue_value|default:"0" }}
                    {% else %}
                        <input name="revenue_value" />
                    {% endif %}
                </td>
                <td>
                    <div id="ga_revenue"></div>
                </td>
            </tr>
        </table>
        <div id="funnel">

        </div>
        {% if ga_users %}
        <script type="text/javascript">
            $(function(){
                var colors = (function () {
            var hues = [.6, .2, .05, .1333, .75, 0],
                colors = [];

            for (var i = 0; i < 10; i++) {
                if (i < hues.length) {
                    colors.push('hsb(' + hues[i] + ',.75, .75)');
                } else {
                    colors.push('hsb(' + hues[i - hues.length] + ', 1, .5)');
                }
            }

            return colors;
    })();
                var w1 = $("#ga_acquisition").width();
                var h = $("#ga_acquisition").parent().height();
                var r = Raphael('ga_acquisition', w1, h);
                var a1_value = {{ ga_users|default:"0" }};
                var a2_value = {{ activation_value|default:"0" }};
                var w2 = Math.floor(w1*a2_value/a1_value);
                var bottom_offset = Math.floor((w1 - w2)/2);
                r.path("M0,0L" + w1 + ",0T" + (w1 - bottom_offset) + "," + h + "L" + bottom_offset + "," + h + "T0,0").attr({
                    "fill": colors[0],
                    "stroke-width": "0"
                });

{#                var w2 = $("#ga_activation").width();#}
                var h = $("#ga_activation").parent().height();
                var top_offset = Math.floor((w1-w2)/2);
                var r = Raphael('ga_activation', w2, h);
                var a1_value = {{ activation_value|default:"0" }};
                var a2_value = {{ retention_value|default:"0" }};
                var w22 = Math.floor(w2*a2_value/a1_value);
                var bottom_offset = Math.floor((w2 - w22)/2);
                r.path("M" +  top_offset +  ",0L" + (top_offset+w2) + ",0T" + ( top_offset + w2) + "," + h + "L" + (top_offset + bottom_offset) + "," + h + "T" + top_offset + ",0").attr({
                    "fill": colors[1],
                    "stroke-width": "0"
                });
{#                r.hbarchart(0, 0, 600, 600, [#}
{#                    {{ ga_users|default:"0" }},#}
{#                    {{ activation_value|default:"0" }},#}
{#                    {{ retention_value|default:"0" }},#}
{#                    {{ referral_value|default:"0" }},#}
{#                    {{ revenue_value|default:"0" }}#}
{#                ], {});#}
            });
        </script>
    {% endif %}
    </div>
{% endblock %}